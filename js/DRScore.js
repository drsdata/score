function DRScore(e){return this instanceof DRScore?(this.option={lineWidth:20,beatHeight:40,maxColBeat:16,iconScale:.8},this.drs=DRScript.parse(e),this.instanceNumber=parseInt(1e9*Math.random()),void this.draw()):new DRScore(e)}DRScore.prototype.drop=function(e){e.preventDefault();var instance=this;try{var file=e.dataTransfer.files[0],r=new FileReader;r.readAsText(file,"utf-8"),r.addEventListener("load",function(e){try{eval(r.result),instance.drs=DRScript.parse(drsData.join("\r\n")),instance.draw()}catch(error){throw error}})}catch(error){throw error}},DRScore.prototype.draw=function(){function e(e,t){for(var i=4,a=4,s=0;s<e.measure.length&&e.measure[s].measure<=t;s++)i=e.measure[s].valueS,a=e.measure[s].valueB;return{valueS:i,valueB:a,measure:t}}function t(e,t,i){for(var a="",s=0;s<e.length;s++){var r=e[s],o=n(r.end)+5+(d.option.lineWidth-21)/2,l=d.option.iconScale;if(r.drawed!==t.measure){if(r.drawed=t.measure,r.from.measure===t.measure&&r.from.measure===r.to.measure){var c=r.from.point*d.option.beatHeight,h=r.to.point*d.option.beatHeight,p=h-c;e.splice(s,1),s--}else if(r.from.measure===t.measure)var c=r.from.point*d.option.beatHeight,h=t.valueS/t.valueB*4*d.option.beatHeight,p=h-c;else if(r.to.measure===t.measure){var c=0,h=r.to.point*d.option.beatHeight,p=h-c;e.splice(s,1),s--}else var c=0,h=t.valueS/t.valueB*4*d.option.beatHeight,p=h-c;var u="height:"+p+"px;left:"+o+"px;bottom:"+c+"px;";u+="-webkit-transform:scaleX("+l+");",u+="transform:scaleX("+l+");",a+='<div class="'+i+'line" style="'+u+'"></div>'}}return a}function i(e,t,a){var s="";if(0!==e.length){var o=e[0],l=o.height+5,c=r(o.obj.point)+10.5,h=n(o.obj.end)+7.5+(d.option.lineWidth-21)/2,p=d.option.iconScale,u=o.rotate,v="4.25px 100%",m="height:"+l+"px;left:"+h+"px;bottom:"+c+"px;";m+="-webkit-transform:rotate("+u+"rad) scaleX("+p+");-webkit-transform-origin:"+v+";",m+="transform:rotate("+u+"rad) scaleX("+p+");transform-origin:"+v+";",s+='<div class="'+a+'-slide-line" style="'+m+'"></div>',e.shift(),s+=i(e,t,a)}return s}function a(t,i,a){for(var s=d.drs,n={from:{measure:0,point:0},to:{measure:0,point:0},drawed:0,end:0},r=a+1;r<s.obj.length&&s.obj[r].end!==t.end;r++);var o=s.obj[r];e(s,o.measure);return n.from.measure=t.measure,n.from.point=t.point,n.to.measure=o.measure,n.to.point=o.point,n.end=o.end,n}function s(t,i,a){var s=d.drs,r=0,o=null,l={rotate:0,height:0,writed:0,obj:null};if(0===t.group)return null;r+=i.valueS/i.valueB*4-t.point;for(var c=a+1;c<s.obj.length;c++)if(t.group===s.obj[c].group){o=s.obj[c];break}if(null===o)return null;var h=e(s,o.measure);r-=h.valueS/h.valueB*4-o.point;for(var p=t.measure+1;p<=o.measure;p++){var u=e(s,p);r+=u.valueS/u.valueB*4}var v=n(o.end)-n(t.end),m=r*d.option.beatHeight;return l.height=Math.sqrt(v*v+m*m),l.rotate=Math.abs(Math.atan(v/m))*(o.end<t.end?-1:1),l.writed=0,l.obj=t,l}function n(e){return(e-1)*d.option.lineWidth-1}function r(e){return e*d.option.beatHeight-11.5}function o(e){for(var t=d.drs,i=v;i<t.newLine.length&&t.newLine[i]<=e;i++)if(t.newLine[i]===e)return v++,!0;return!1}var l=0,d=this,c=0,h=0,p=[],u=[],v=0,m=this.drs.type,b=this.drs.maxBpm!==this.drs.minBpm?!0:!1,f=["DEBUT","REGULAR","PRO","MASTER","MASTER+"];if(isNaN(this.option.maxColBeat))throw new Error("maxColBeat value error");var g=document.getElementById("board"+this.instanceNumber);if(null===g){var B="";B+='<div id="drscore'+this.instanceNumber+'">',B+='<div id="head'+this.instanceNumber+'"></div>',B+='<div id="board'+this.instanceNumber+'"></div>',B+='<div id="setting'+this.instanceNumber+'" class="setting">',B+='<input type="checkbox" id="on'+this.instanceNumber+'"/>',B+='<label for="on'+this.instanceNumber+'" id="onlabel'+this.instanceNumber+'"/>表示設定</label>',B+='<div class="mainboard">',B+="<ul>",B+='<li><label>表示サイズ<select id="change-size'+this.instanceNumber+'">',B+="<option >極小</option><option>小</option><option selected>中</option><option>大</option><option>極大</option></select></label></li>",B+='<li><label>一列の拍数<select id="change-beat'+this.instanceNumber+'">',B+="<option>8</option><option>16</option><option>20</option><option selected>24</option><option>32</option><option>48</option><option>64</option><option>ALL</option>",B+="</select></label></li>",B+="</ul>",B+="</div>",B+="</div>",B+="</div>",document.write(B);var S=document.getElementById("drscore"+this.instanceNumber),g=document.getElementById("board"+this.instanceNumber),y=document.getElementById("setting"+this.instanceNumber);if(S.addEventListener){S.addEventListener("dragover",function(e){e.preventDefault()}),S.addEventListener("drop",this.drop.bind(this));var k="undefined"==typeof window.ontouchstart?"mousedown":"touchstart",w=document.getElementById("on"+this.instanceNumber);g.addEventListener(k,function(e){w.checked&&(w.checked=!1)});var x=document.getElementById("onlabel"+this.instanceNumber);x.addEventListener("touchstart",function(e){e.preventDefault(),w.checked=w.checked?!1:!0});var L=function(e){switch(N.value){case"極小":d.setLineWidth(10),d.setBeatHeight(16),d.setIconScale(.4);break;case"小":d.setLineWidth(12),d.setBeatHeight(22),d.setIconScale(.5);break;case"中":d.setLineWidth(16),d.setBeatHeight(30),d.setIconScale(.6);break;case"大":d.setLineWidth(20),d.setBeatHeight(40),d.setIconScale(.8);break;case"極大":d.setLineWidth(24),d.setBeatHeight(45),d.setIconScale(1)}switch(H.value){case"ALL":d.setMaxColBeat(1e4);break;default:d.setMaxColBeat(parseInt(H.value))}d.draw()},N=document.getElementById("change-size"+this.instanceNumber),H=document.getElementById("change-beat"+this.instanceNumber);switch(N.addEventListener("change",L),H.addEventListener("change",L),N.value){case"極小":d.setLineWidth(10),d.setBeatHeight(16),d.setIconScale(.4);break;case"小":d.setLineWidth(12),d.setBeatHeight(22),d.setIconScale(.5);break;case"中":d.setLineWidth(16),d.setBeatHeight(30),d.setIconScale(.6);break;case"大":d.setLineWidth(20),d.setBeatHeight(40),d.setIconScale(.8);break;case"極大":d.setLineWidth(24),d.setBeatHeight(45),d.setIconScale(1)}switch(H.value){case"ALL":d.setMaxColBeat(1e4);break;default:d.setMaxColBeat(parseInt(H.value))}}else y.style.display="none"}var S=document.getElementById("drscore"+this.instanceNumber),I=document.getElementById("head"+this.instanceNumber),g=document.getElementById("board"+this.instanceNumber);S.className="drscore type"+this.drs.type,I.className="head",g.className="board";var E="";E+="<h1>"+this.drs.title+" ("+f[this.drs.difficulty]+")</h1>",E+='<div class="info">',E+='<span class="level">★'+this.drs.level+"</span>",E+='<span class="combo">COMBO:'+this.drs.combo+"</span>",E+=this.drs.maxBpm===this.drs.minBpm?'<span class="bpm">BPM:'+this.drs.maxBpm+"</span>":'<span class="bpm">BPM:'+parseInt(this.drs.minBpm)+"～"+parseInt(this.drs.maxBpm)+"</span>",E+="</div>",I.innerHTML=E,g.innerHTML="";var D=document.createElement("table");D.className="col",g.appendChild(D);var M=D.insertRow(0);M.className="col";for(var c=0;c<this.drs.endMeasure;){var W=M.insertCell(-1);W.className="col";var R=document.createElement("table");R.className="row",W.appendChild(R);for(var j=0,C=0;j<this.option.maxColBeat;C++){var T=e(this.drs,c+1);if(o(T.measure))break;if(j+=T.valueS/T.valueB*4,h+=T.valueS/T.valueB*4,0!==C&&j>this.option.maxColBeat)break;if(this.option.maxColBeat>=this.drs.endBeat&&h>this.drs.endBeat){c++;break}c++;var A="",X="",z=R.insertRow(0);z.className="row";var O=document.createElement("th");z.appendChild(O),O.className="row";var P=z.insertCell(-1);if(P.className="row",P.style.height=this.option.beatHeight*(T.valueS/T.valueB)*4-1+"px",A+=T.measure,A+="<div style='width:18px;'></div>",X+='<div class="back" id="back'+T.measure+'" style="width : '+(5*this.option.lineWidth-1)+'px;"></div>',backDivStr="",b)for(var U in this.drs.bpm){var q=this.drs.bpm[U];if(q.measure===T.measure){for(var F=q.point*d.option.beatHeight+1,G=1;Math.pow(10,G-1)<q.value;G++){var J="";J+="background-position : -"+parseInt(q.value/Math.pow(10,G-1))%10*4+"px -5px;",J+="right : "+(4*(G-1)+1)+"px;",J+="bottom : "+F+"px;",A+='<span class="number" style="'+J+'"></span>'}A+='<div class="bpm-line" style="bottom : '+(F-2)+'px"></div>'}}for(var U=1;U<T.valueS/T.valueB*4;U++)X+='<div class="measure-line1" style="width:'+(5*this.option.lineWidth-1)+"px;bottom:"+(U*this.option.beatHeight-1)+'px"></div>';for(var U=1;U<T.valueS/T.valueB*8;U+=2)X+='<div class="measure-line2" style="width:'+(5*this.option.lineWidth-1)+"px;bottom:"+(U*(this.option.beatHeight/2)-1)+'px"></div>';for(var U=1;5>U;U++)X+='<div class="measure-line3" style="height:'+(this.option.beatHeight*(T.valueS/T.valueB)*4-1)+"px;left:"+(U*this.option.lineWidth-1)+'px"></div>';backDivStr+=t(u,T,m);for(var U=l;U<this.drs.obj.length;U++){var K=this.drs.obj[U];if(K.measure!==T.measure){K.measure>T.measure&&(l=U);break}var Q=n(K.end)+(this.option.lineWidth-21)/2,F=r(K.point),V=this.drs.obj.length-U+100;switch(K.type){case 1:V+=0;break;case 2:V+=1e3;break;case 3:V+=1e3;break;case 4:V+=2e3;break;case 5:V+=2e3}var Y=this.option.iconScale,J="left:"+Q+"px;bottom:"+F+"px;z-index:"+V+";";if(J+="-webkit-transform:scale("+Y+");",J+="transform:scale("+Y+");",U+1<this.drs.obj.length-1&&K.measure===this.drs.obj[U+1].measure&&K.point===this.drs.obj[U+1].point){var Z=n(this.drs.obj[U+1].end)+(this.option.lineWidth-21)/2,$=Math.min(Q,Z)+10,_=Math.abs(Q-Z),ee=F+9.5;X+='<div class="same-line" style="width:'+_+"px;left:"+$+"px;bottom:"+ee+'px"></div>'}switch(K.type){case 1:X+='<div class="icon '+m+'" style="'+J+'"><div></div></div>';break;case 2:X+='<div class="icon '+m+'" style="'+J+'"><div><div class="long"></div></div></div>',u.push(a(K,T,U)),backDivStr+=t(u,T,m);break;case 3:X+='<div class="icon '+m+'" style="'+J+'"><div><div class="long"></div></div></div>';break;case 4:X+='<div class="icon '+m+'" style="'+J+'"><div><div class="slide left"></div></div></div>';var te=s(K,T,U);null!==te&&(p.push(te),backDivStr+=i(p,K.point,m));break;case 5:X+='<div class="icon '+m+'" style="'+J+'"><div><div class="slide right"></div></div></div>';var te=s(K,T,U);null!==te&&(p.push(te),backDivStr+=i(p,K.point,m))}}O.innerHTML=A,P.innerHTML=X,backDiv=document.getElementById("back"+T.measure),backDiv.innerHTML=backDivStr}backDiv&&(backDiv.style.overflow="hidden")}},DRScore.prototype.setLineWidth=function(e){this.option.lineWidth=e},DRScore.prototype.setBeatHeight=function(e){this.option.beatHeight=e},DRScore.prototype.setMaxColBeat=function(e){this.option.maxColBeat=e},DRScore.prototype.setIconScale=function(e){this.option.iconScale=e};